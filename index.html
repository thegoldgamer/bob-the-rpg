<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>bob - The RPG — Game</title>
  <style>
    :root {
      /* Default (overridden automatically if canvas is detected) */
      --game-width: 640px;
      --game-height: 480px;
      --page-bg: #0b0b0b;
      --panel-bg: #0f1720;
      --accent: #3ddc84;
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      background: linear-gradient(180deg, var(--page-bg), #071017);
      color: #e6eef8;
    }

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 24px;
      box-sizing: border-box;
    }

    .game-wrapper {
      width: var(--game-width);
      height: var(--game-height);
      margin-top: 20px;
      background: var(--panel-bg);
      box-shadow: 0 8px 30px rgba(2,6,23,0.6);
      border-radius: 6px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .game-frame {
      width: 100%;
      height: 100%;
      border: 0;
      display: block;
      background: #000;
    }

    .placeholder {
      padding: 28px;
      text-align: center;
      color: #bcd7d1;
    }

    .hint {
      margin-top: 18px;
      font-size: 13px;
      color: #9fb8b0;
    }

    main.article {
      max-width: 860px;
      width: 100%;
      margin-top: 28px;
      color: #d9eef2;
      line-height: 1.5;
    }

    a.action {
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
    }

    footer {
      margin: 48px 0 24px;
      color: #7ea59b;
      font-size: 13px;
    }

    @media (max-width: 720px) {
      .page { padding: 16px; }
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>bob - The RPG</h1>
    <p style="margin:0; color:#9fb8b0">Game preview — drop your exported HTML5 game into the <code>/game</code> folder.</p>

    <div class="game-wrapper" id="gameWrapper">
      <iframe id="gameFrame" class="game-frame" title="bob - The RPG game" src="" aria-label="Game frame"></iframe>

      <div id="placeholder" class="placeholder" style="display:none">
        <strong>No game found</strong>
        <div class="hint">Put your exported HTML5 game's files into the <code>/game</code> folder and make sure there's an <code>index.html</code> there.</div>
        <div class="hint">Default canvas size is controlled by the CSS variables <code>--game-width</code> and <code>--game-height</code> at the top of this file. The page will attempt to auto-detect the correct size.</div>
      </div>
    </div>

    <main class="article">
      <h2>About</h2>
      <p>This page loads <code>/game/index.html</code> in an iframe, auto-detects the exported game's canvas size, and forces pixelated rendering for the canvas so pixel art remains crisp.</p>

      <h3>Quick checklist</h3>
      <ul>
        <li>Export your game from GameMaker as HTML5.</li>
        <li>Copy the exported files into the repository's <code>game/</code> folder (so <code>game/index.html</code> exists).</li>
        <li>If auto-detection fails, set <code>--game-width</code> and <code>--game-height</code> at the top of this file manually.</li>
      </ul>
    </main>

    <footer>Made with ♥ — drop your exported HTML5 into <code>/game</code>.</footer>
  </div>

  <script>
    (function() {
      var frame = document.getElementById('gameFrame');
      var placeholder = document.getElementById('placeholder');
      var wrapper = document.getElementById('gameWrapper');
      var gameUrl = './game/index.html';

      function showPlaceholder() {
        frame.style.display = 'none';
        placeholder.style.display = 'block';
      }
      function showFrame() {
        frame.style.display = 'block';
        placeholder.style.display = 'none';
      }

      fetch(gameUrl, { method: 'GET' })
        .then(function(response) {
          if (response.ok) {
            frame.src = gameUrl;
            showFrame();

            // When the iframe finishes loading, try to find the canvas and adjust sizing/rendering.
            frame.addEventListener('load', function() {
              try {
                var win = frame.contentWindow;
                var doc = frame.contentDocument || win.document;

                // Remove default margins inside the iframe to avoid extra spacing
                try { doc.documentElement.style.background = 'transparent'; } catch(e){}
                try { doc.body.style.margin = '0'; } catch(e){}

                // Some engines create the canvas after load; poll briefly for it.
                var tries = 0;
                var maxTries = 50;
                var interval = setInterval(function() {
                  tries++;
                  var canvas = null;
                  try {
                    canvas = doc && (doc.querySelector('canvas') || doc.getElementsByTagName('canvas')[0]);
                  } catch (e) {
                    clearInterval(interval);
                    console.warn('Cannot access iframe content (cross-origin?), leaving default sizing.');
                    return;
                  }

                  if (canvas) {
                    clearInterval(interval);

                    // Get the canvas pixel (logical) size from attributes first, fallback to computed sizes.
                    var w = canvas.width || parseInt(canvas.getAttribute('width')) || canvas.clientWidth || Math.round(canvas.getBoundingClientRect().width) || 640;
                    var h = canvas.height || parseInt(canvas.getAttribute('height')) || canvas.clientHeight || Math.round(canvas.getBoundingClientRect().height) || 480;

                    // Update CSS variables and wrapper sizing so browser does not scale the canvas.
                    document.documentElement.style.setProperty('--game-width', w + 'px');
                    document.documentElement.style.setProperty('--game-height', h + 'px');
                    wrapper.style.width = w + 'px';
                    wrapper.style.height = h + 'px';

                    // Inject CSS into the iframe to force nearest-neighbor / pixelated rendering for canvas
                    try {
                      var style = doc.createElement('style');
                      style.type = 'text/css';
                      style.appendChild(doc.createTextNode('\nhtml,body{margin:0;background:transparent}\ncanvas{image-rendering: pixelated; image-rendering: crisp-edges; -ms-interpolation-mode: nearest-neighbor;}\n'));
                      (doc.head || doc.documentElement).appendChild(style);
                    } catch (e) {}

                    // Also mark the canvas element itself (in case it's inline-styled)
                    try {
                      canvas.style.imageRendering = 'pixelated';
                      canvas.style.setProperty('image-rendering', 'pixelated');
                    } catch (e) {}

                    // If your game uses CSS scaling internally, it might still blur; prefer the engine's canvas width/height attributes.
                  } else if (tries >= maxTries) {
                    clearInterval(interval);
                    console.warn('No canvas found inside game iframe.');
                  }
                }, 100);

              } catch (e) {
                console.warn('Error while accessing iframe content:', e);
              }
            });

          } else {
            showPlaceholder();
          }
        })
        .catch(function() {
          showPlaceholder();
        });
    })();
  </script>
</body>
</html>
